#!/usr/bin/env bash
set -o errtrace  # -E trap inherited in sub script
set -o errexit   # -e
set -o functrace # -T If set, any trap on DEBUG and RETURN are inherited by shell functions
set -o pipefail  # default pipeline status==last command status, If set, status=any command fail


PA_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
cd "$PA_DIR"

# shellcheck disable=SC1091
source "./common.bash"

# nullglobé€‰é¡¹é»˜è®¤offæ—¶ï¼š
# -------------------------.bash
# bash-5.2$ a=(./no_exists_dir/*/sha)
# bash-5.2$ declare -p a
# declare -a a=([0]="./no_exists_dir/*/sha")
# -------------------------
# æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•æ–‡ä»¶æ—¶ï¼ŒåŒ…å«å­—ç¬¦ä¸²å­—é¢é‡ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬è¦çš„
#
# è€Œæ‰“å¼€nullglobåï¼š
# -------------------------.bash
# shopt -s nullglob
# bash-5.2$ a=(./no_exists_dir/*/sha)
# bash-5.2$ declare -p a
# declare -a a=()
# -------------------------s
# ç©ºæ•°ç»„!è¿™æ˜¯æˆ‘ä»¬æƒ³è¦çš„
shopt -s nullglob

#############################################################
### åŸºäºbashè„šæœ¬çš„monoé¡¹ç›®ç®¡ç†
### 1. ç§°å‘¼: workspace/project/å­é¡¹ç›®,åè¯ç­‰åŒ
### 2. å­é¡¹ç›®çš„è®¤å®š: åŒ…å«shaè„šæœ¬çš„ç›®å½•ï¼Œå°±æ˜¯å­é¡¹ç›®è·¯å¾„
### 3. å­é¡¹ç›®åˆ—è¡¨(_workspace_list): åŒ…å«shaè„šæœ¬çš„ç›®å½•çš„åˆ—è¡¨
### 4. å­é¡¹ç›®å: é¡¹ç›®ç›®å½•çš„basenameï¼Œæ¯”å¦‚./packages/core, åç§°ä¸ºcore
#############################################################
declare -a _workspace_list=()
# è¿›ç¨‹æ›¿æ¢è¾“å…¥å†…å®¹ç»™æ•°ç»„ï¼šå–æ‰€æœ‰pathçš„dirnameï¼Œæœ€ç»ˆå¾—åˆ°å­é¡¹ç›®ç›®å½•
readarray -t _workspace_list < <(
  declare -a _workspace_sha_paths=(./sha ./packages/*/sha);
  printf "%s\n" "${_workspace_sha_paths[@]}" | xargs dirname
) # è¿›ç¨‹æ›¿æ¢çš„å³æ‹¬å·åä¸éœ€è¦åˆ†å·

_all_projects() { printf "%s\n" "${_workspace_list[@]}";}
_npm_projects() { _all_projects | grep -E -v "^\.$" ;}

# é¡¹ç›®ç»„ï¼Œå³å­é¡¹ç›®ç»„
declare -a _on_workspace_list=()
readarray -t _on_workspace_list < <(_all_projects) ;

g() {
  all() {
    readarray -t _on_workspace_list < <(_all_projects) ;
    _workspace_context_commands
  }
  pkgs() {
    readarray -t _on_workspace_list < <(_npm_projects) ;
    _workspace_context_commands
  }
}

_packages() {
  local workspace
  for workspace in "${@}"; do
    echo "$workspace" | xargs basename | xargs -I {} echo @qpa/{}
  done
}

##########################################
# app cmd script
# åº”ç”¨çš„å‘½ä»¤è„šæœ¬
##########################################
_all_workspaces() {
    for file_path in "${_workspace_sha_paths[@]}"; do
      # ä½¿ç”¨å‚æ•°å±•å¼€ï¼Œç§»é™¤å­—ç¬¦ä¸²ç»“å°¾çš„æœ€çŸ­åŒ¹é… "/sha"
      dir_path="${file_path%/sha}"
      echo "$dir_path"
    done
}

_workspace_context_commands() {

  list() {
    for project_dir in "${_on_workspace_list[@]}"; do
       echo "$project_dir"
    done
  }

  run() {
    for project_dir in "${_on_workspace_list[@]}"; do
      echo "ğŸ˜€project: $project_dir"
      cd "$PA_DIR/$project_dir"
      _run "$@"
      echo
    done
  }

  clean() {
    for project_dir in "${_on_workspace_list[@]}"; do
      echo "ğŸ˜€project: $project_dir"
      _run "$project_dir/sha" clean
      echo
    done
  }

  tests() {
    for project_dir in "${_on_workspace_list[@]}"; do
      echo "project: $project_dir"
       _run "$project_dir/sha" tests
    done
  }
}

# npm åå­—å’Œå·²æœ‰å‘½ä»¤é‡å¤
npmjs() {
  login() {
    # æŒ‡å®š--registryé˜²æ­¢ç™»é™†è·³è½¬åˆ°é•œåƒç½‘ç«™
    npm login --registry=https://registry.npmjs.org/
  }
}

clean() {
  echo "root workspace: clean"
}

tests() {
  echo "root workspace: clean"
}

info2() {
  echo "## workspaces:"
  printf "  %s\n" "${_workspace_list[@]}"
  echo "## packages:"
  printf "  %s\n" $(_packages "${_workspace_list[@]}")
  echo "## out ip:"
  echo "  $(curl ipinfo.io/ip 2>/dev/null)"
}

cli() {
#  _run "$PA_DIR/packages/cli/sha" || printf "%b\n" "------------------\n [cli $@], exit code($?)" ;
  _run "$PA_DIR/packages/core/sha" "$@" || printf "%b\n" "------------------\n [cli $@], exit code($?)" ;
}

version() {
  info() {
     npm version --workspaces "$@"
  }
  patch() {
    npm version patch --workspaces "$@"
  }
  prerelease() {
    npm version prerelease --workspaces "$@"
  }
  push() {
    git push origin --tags  "$@"
  }
}

sha "$@"