#!/usr/bin/env bash
set -o errtrace  # -E trap inherited in sub script
set -o errexit   # -e
set -o functrace # -T If set, any trap on DEBUG and RETURN are inherited by shell functions
set -o pipefail  # default pipeline status==last command status, If set, status=any command fail

SHAS_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
cd "$SHAS_DIR"

# shellcheck disable=SC1091
source "./common.bash"

# ############################################################
# åŸºäºbashè„šæœ¬çš„monoé¡¹ç›®ç®¡ç†
# 1. åè¯:workspace/project/å­é¡¹ç›®,åè¯ç­‰åŒ
# 2. shasè„šæœ¬ä¸ºæ ¹è„šæœ¬ï¼Œä¸»è¦æ˜¯éå†å¤šä¸ªé¡¹ç›®æ‰§è¡Œå‘½ä»¤ï¼Œè€Œå„å­é¡¹ç›®çš„shaæ‰§è¡Œå®é™…æœ¬é¡¹ç›®å‘½ä»¤
# 3. é¡¹ç›®ç»„æ˜¯ç›¸åŒä½“ç³»è§„èŒƒçš„ä¸€ç»„é¡¹ç›®å®¹å™¨ï¼Œå¯å…±äº«å‘½ä»¤å®ç°ï¼Œ
#    æ¯”å¦‚å®šä¹‰ä¸€ä¸ªnpmç»„ï¼Œbuildå‘½ä»¤åªéœ€è¦å†™ä¸€æ¬¡å°±å¯ä»¥è¢«æ‰€æœ‰npmé¡¹ç›®ä½¿ç”¨ï¼Œé™¤éé¡¹ç›®æœ¬èº«å¯¹buildå‘½ä»¤æœ‰å…¶ç‰¹æ®Šå®ç°ï¼Œå¯è¦†ç›–ä¹‹
# 4. å¤šé¡¹ç›®å‘½ä»¤çš„å®ç°å’Œæ‰§è¡Œåˆ†3ä¸ªå±‚çº§ï¼šshas -> é¡¹ç›®ç»„-> é¡¹ç›®
#    æ¯”å¦‚æ‰§è¡Œ'shas build'ï¼Œå…ˆå¾ªç¯ä¸€ç»„é¡¹ç›®ï¼Œæ¯ä¸ªé¡¹ç›®åŠ è½½å…¶æ‰€å±é¡¹ç›®ç»„buildå‡½æ•°ï¼Œå†åŠ è½½é¡¹ç›®è‡ªå·±shaè„šæœ¬buildå‡½æ•°ï¼Œ
#    åˆ©ç”¨bashè„šæœ¬åå®šä¹‰çš„å‡½æ•°å¯è¦†ç›–å…ˆå®šä¹‰çš„å‡½æ•°çš„ç‰¹æ€§ï¼Œå¦‚æœé¡¹ç›®çš„shaè„šæœ¬æ²¡æœ‰buildå‡½æ•°å®ç°ï¼Œå°±æ‰§è¡Œé¡¹ç›®ç»„çš„buildå‡½æ•°ï¼Œ
#    å¦åˆ™ï¼Œæ‰§è¡Œé¡¹ç›®è‡ªå·±çš„buildå‡½æ•°ã€‚
# 5. é¡¹ç›®å®šä¹‰æ—¶æŒ‰ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„ï¼Œå…¶ä½œä¸ºé¡¹ç›®è¿‡æ»¤çš„ä¾æ®
#############################################################
declare -a __project_group_pnpm=(
.
./packages/core
./packages/provider-tencentcloud
./packages/cli
)
declare -a __project_group_other=()

declare -a __project_array=("${__project_group_other[@]}"  "${__project_group_pnpm[@]}")

# å½“å‰å¾…å¤„ç†çš„é¡¹ç›®æ•°ç»„ï¼Œæš‚æ—¶å…¨éƒ¨ï¼Œå›å¤´åŠ è¿‡æ»¤å™¨
declare -a __current_project_array=("${__project_array[@]}")

__current_projects() { printf "%s\n" "${__current_project_array[@]}";}

# Usage: __run_project_cmd <project> <cmd>
# æœ¬å‡½æ•°åšå¤šæ¬¡åŠ è½½ç›¸å…³é¡¹ç›®çš„å‘½ä»¤é›†ï¼Œå¤–éƒ¨æ‰§è¡Œæ—¶æœ€å¥½ç”¨å­è¿›ç¨‹å½¢å¼æ‰§è¡Œï¼š( __run_project_cmd "project" "cmd" )
__run_project_cmd(){
  local project="$1"
  local cmd="$2"
  if [[ "$project" == "" ]]; then echo "ERROR: ç¼ºå°‘<project>å‚æ•°,Usage: __run_project_cmd <project> <cmd>"; fi
  if [[ "$cmd" == "" ]];     then echo "ERROR: ç¼ºå°‘<cmd>å‚æ•°,Usage: __run_project_cmd <project> <cmd>"; fi

  shift 2
  local before_load
  before_load=$(declare -f $cmd)

  cd "$project"

  for n in "${__project_group_pnpm[@]}"; do
    if [[ "$project" == "$n" ]]; then
      _project_group_pnpm_on
      break;
    fi
  done

  ## load cmd function from project
  if [ -f "./sha" ]; then
    . "./sha"
  fi

  local after_load
  after_load=$(declare -f "$cmd")
  # å¦‚æœcmdçš„å‡½æ•°åŠ è½½å‰åå†…å®¹ç›¸åŒï¼Œè¯´æ˜ç”¨æˆ·å¹¶ä¸ºå®šä¹‰ç›¸å…³å‡½æ•°ï¼Œåˆ™å¿½ç•¥æ‰§è¡Œ
  if [[ "$before_load" == "$after_load" ]]; then
    echo "  âšªï¸ignore é¡¹ç›® $project æ‰§è¡Œ $cmd, å› ä¸ºæ‚¨æœªå®šä¹‰[$cmd]å‡½æ•°å®ç°"
    return 0
  fi
  # æ‰§è¡Œç›¸åº”çš„å‘½ä»¤å‡½æ•°
#  echo "run: $after_load"
  $cmd "$@"
}

__run__current_projects() {
  local cmd="$1"
  if [[ "$cmd" == "" ]];     then echo "ERROR: ç¼ºå°‘<cmd>å‚æ•°,Usage: __run__current_projects <cmd>"; fi

  local project_dir;
  for project_dir in "${__current_project_array[@]}"; do
    # ç”¨()å»ºç«‹å­è¿›ç¨‹ï¼Œæ‰§è¡Œæ—¶äº’ä¸å¹²æ‰°
    (
        echo "ğŸŸª project: $project_dir"
        __run_project_cmd "$project_dir" "$cmd" "$@"
    )
  done
}


##########################################
# app cmd script
# åº”ç”¨çš„å‘½ä»¤è„šæœ¬
##########################################

exec() {
  for project_dir in "${__current_project_array[@]}"; do
    echo "ğŸ˜€project: '$project_dir'"
    cd "$SHAS_DIR/$project_dir"
    _run "$@"
    echo
  done
}

clean() {          __run__current_projects "clean"         "$@";}
install() {        __run__current_projects "install"       "$@";}
build() {          __run__current_projects "build"         "$@";}
pack() {           __run__current_projects "pack"          "$@";}
test() {           __run__current_projects "test"          "$@";}
clean_build() {    __run__current_projects "clean_build"   "$@";}
clean_test() {     __run__current_projects "clean_test"    "$@";}
clean_pack() {     __run__current_projects "clean_pack"    "$@";}


# npm åå­—å’Œå·²æœ‰å‘½ä»¤é‡å¤
npmjs() {
  login() {
    # æŒ‡å®š--registryé˜²æ­¢ç™»é™†è·³è½¬åˆ°é•œåƒç½‘ç«™
    npm login --registry=https://registry.npmjs.org/
  }
}

status() {
  echo "## workspaces:"
  printf "  %s\n" "${__project_array[@]}"
  echo "## packages:"
  printf "  %s\n" "$(_dir_to_package_name "${__project_array[@]}")"
  echo "## out ip:"
  echo "  $(curl ipinfo.io/ip 2>/dev/null)"
}

version() {
  info() { npm version --workspaces "$@"; }
  patch() { npm version patch --workspaces "$@"; }
  prerelease() { npm version prerelease --workspaces "$@";}
  push() {  git push origin --tags  "$@" ; }
}


# å®ˆå«è¯­å¥ï¼Œå½“'source ./sha'æ‰§è¡Œï¼Œè„šæœ¬è¢«å½“ç±»åº“å¯¼å…¥æ—¶ï¼Œ$0ä¸ºbashæˆ–zshç­‰å€¼
# å³å½“ç±»åº“å¼•ç”¨æ—¶ä¸æ‰§è¡Œåç»­å‘½ä»¤å¼å…¥å£ä»£ç 
if [[ "${BASH_SOURCE[0]}" != "$0" ]]; then
  echo 'shasè„šæœ¬ä¸ºmonoé¡¹ç›®è„šæœ¬ï¼Œä¸èƒ½ä½œä¸ºç±»åº“å¯¼å…¥ï¼Œåªèƒ½å‘½ä»¤å¼æ‰§è¡Œ'
  exit 1
fi

# å½“è„šæœ¬è¢«ç›´æ¥æ‰§è¡Œçš„å…¥å£ä»£ç 
sha "$@"
