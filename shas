#!/usr/bin/env bash
set -o errtrace  # -E trap inherited in sub script
set -o errexit   # -e
set -o functrace # -T If set, any trap on DEBUG and RETURN are inherited by shell functions
set -o pipefail  # default pipeline status==last command status, If set, status=any command fail

SHAS_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
cd "$SHAS_DIR"

# shellcheck disable=SC1091
source "./common.bash"

#############################################################
### åŸºäºbashè„šæœ¬çš„monoé¡¹ç›®ç®¡ç†
### 1. ç§°å‘¼: workspace/project/å­é¡¹ç›®,åè¯ç­‰åŒ
### 2. å­é¡¹ç›®çš„è®¤å®š: åŒ…å«shaè„šæœ¬çš„ç›®å½•ï¼Œå°±æ˜¯å­é¡¹ç›®è·¯å¾„
### 3. å­é¡¹ç›®åˆ—è¡¨(_work_on_projects): åŒ…å«shaè„šæœ¬çš„ç›®å½•çš„åˆ—è¡¨
### 4. å­é¡¹ç›®å: é¡¹ç›®ç›®å½•çš„basenameï¼Œæ¯”å¦‚./packages/core, åç§°ä¸ºcore
#############################################################
declare -a _group_npm=(
.
./packages/core
./packages/provider-tencentcloud
./packages/cli
)
declare -a _group_other=()

declare -a _project_array=("${_group_other[@]}"  "${_group_npm[@]}")

# é¡¹ç›®ç»„ï¼Œå³å­é¡¹ç›®ç»„, æš‚æ—¶å·¥ä½œæ•°ç»„ä¸ºå…¨éƒ¨é¡¹ç›®
declare -a _work_on_project_array=("${_project_array[@]}")

_work_on_projects() { printf "%s\n" "${_work_on_project_array[@]}";}

# Usage: _run_project_cmd <project> <cmd>
# æœ¬å‡½æ•°åšå¤šæ¬¡åŠ è½½ç›¸å…³é¡¹ç›®çš„å‘½ä»¤é›†ï¼Œå¤–éƒ¨æ‰§è¡Œæ—¶æœ€å¥½ç”¨å­è¿›ç¨‹å½¢å¼æ‰§è¡Œï¼š( _run_project_cmd "project" "cmd" )
_run_project_cmd(){
  local project="$1"
  local cmd="$2"
  if [[ "$project" == "" ]]; then echo "ERROR: ç¼ºå°‘<project>å‚æ•°,Usage: _run_project_cmd <project> <cmd>"; fi
  if [[ "$cmd" == "" ]];     then echo "ERROR: ç¼ºå°‘<cmd>å‚æ•°,Usage: _run_project_cmd <project> <cmd>"; fi

  shift 2
  local before_load
  before_load=$(declare -f $cmd)

  cd "$project"

  for n in "${_group_npm[@]}"; do
    if [[ "$project" == "$n" ]]; then
      _group_npm_on
      break;
    fi
  done

  ## load cmd function from project
  if [ -f "./sha" ]; then
    . "./sha"
  fi

  local after_load
  after_load=$(declare -f "$cmd")
  # å¦‚æœcmdçš„å‡½æ•°åŠ è½½å‰åå†…å®¹ç›¸åŒï¼Œè¯´æ˜ç”¨æˆ·å¹¶ä¸ºå®šä¹‰ç›¸å…³å‡½æ•°ï¼Œåˆ™å¿½ç•¥æ‰§è¡Œ
  if [[ "$before_load" == "$after_load" ]]; then
    echo "  âšªï¸ignore é¡¹ç›® $project æ‰§è¡Œ $cmd, å› ä¸ºæ‚¨æœªå®šä¹‰[$cmd]å‡½æ•°å®ç°"
    return 0
  fi
  # æ‰§è¡Œç›¸åº”çš„å‘½ä»¤å‡½æ•°
#  echo "run: $after_load"
  $cmd "$@"
}

_run_on_work_projects() {
  local cmd="$1"
  if [[ "$cmd" == "" ]];     then echo "ERROR: ç¼ºå°‘<cmd>å‚æ•°,Usage: _run_on_work_projects <cmd>"; fi

  local project_dir;
  for project_dir in "${_work_on_project_array[@]}"; do
    # ç”¨()å»ºç«‹å­è¿›ç¨‹ï¼Œæ‰§è¡Œæ—¶äº’ä¸å¹²æ‰°
    (
        echo "ğŸŸª project: $project_dir"
        _run_project_cmd "$project_dir" "$cmd" "$@"
    )
  done
}


##########################################
# app cmd script
# åº”ç”¨çš„å‘½ä»¤è„šæœ¬
##########################################

exec() {
  for project_dir in "${_work_on_project_array[@]}"; do
    echo "ğŸ˜€project: $project_dir"
    cd "$SHAS_DIR/$project_dir"
    _run "$@"
    echo
  done
}

clean() {    _run_on_work_projects "clean"   "$@";}
install() {  _run_on_work_projects "install" "$@";}
build() {    _run_on_work_projects "build"    "$@";}
test() {     _run_on_work_projects "test"    "$@";}

# npm åå­—å’Œå·²æœ‰å‘½ä»¤é‡å¤
npmjs() {
  login() {
    # æŒ‡å®š--registryé˜²æ­¢ç™»é™†è·³è½¬åˆ°é•œåƒç½‘ç«™
    npm login --registry=https://registry.npmjs.org/
  }
}

status() {
  echo "## workspaces:"
  printf "  %s\n" "${_project_array[@]}"
  echo "## packages:"
  printf "  %s\n" "$(_dir_to_package_name "${_project_array[@]}")"
  echo "## out ip:"
  echo "  $(curl ipinfo.io/ip 2>/dev/null)"
}

version() {
  info() { npm version --workspaces "$@"; }
  patch() { npm version patch --workspaces "$@"; }
  prerelease() { npm version prerelease --workspaces "$@";}
  push() {  git push origin --tags  "$@" ; }
}


# å®ˆå«è¯­å¥ï¼Œå½“'source ./sha'æ‰§è¡Œï¼Œè„šæœ¬è¢«å½“ç±»åº“å¯¼å…¥æ—¶ï¼Œ$0ä¸ºbashæˆ–zshç­‰å€¼
# å³å½“ç±»åº“å¼•ç”¨æ—¶ä¸æ‰§è¡Œåç»­å‘½ä»¤å¼å…¥å£ä»£ç 
if [[ "${BASH_SOURCE[0]}" != "$0" ]]; then
  echo 'shasè„šæœ¬ä¸ºmonoé¡¹ç›®è„šæœ¬ï¼Œä¸èƒ½ä½œä¸ºç±»åº“å¯¼å…¥ï¼Œåªèƒ½å‘½ä»¤å¼æ‰§è¡Œ'
  exit 1
fi

# å½“è„šæœ¬è¢«ç›´æ¥æ‰§è¡Œçš„å…¥å£ä»£ç 
sha "$@"
