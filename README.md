# qpa

terraform是个nb的项目，但使用过程中，有些问题无法克服，遂开发此项目。

## 需求

- 主要用于测试云部署方案的用途，所以
  - 只提供一些主流云的网络、虚拟机等核心组件，够用即可，主要能部署常见的程序栈，ai栈，主要是简单好重建资源。
  - 暂时不考虑资源修改，一律重建，减少复杂性。
- 以lib方式供其他项目引用，而不是像terraform一样的命令行工具。
- 提供简单的api接口，可以快速实现自定义资源，比如只重建不修改的资源代码，其实很少，很简单。
- 基于Typescript的配置，ide支持很好，让配置型项目更容易维护，本来配置型项目，里面会有一些逻辑，hcl配置很快会演变为一种脚本语言维护困难。
  - tfcdk、pulumi本质是golang的命令行工具，而我曾尝试封装，但难度有点高，遂放弃。
- 无状态配置，本地不像terraform一样维护配置状态，而用tag方式直接在云资源本身上标记，这样就从根本上减少多数据源事务不一致问题。
  - 比如截止2025年4月，我在使用腾讯云terraform时，仍然在核心资源cvm上会丢资源，脚本执行失败，但资源实际已在云上建立，而本地丢失状态。
- 提供2种使用方式
  - 过程性/命令式的配置，很多中小配置项目，或实验项目，都需要直接简单的配置，而且过程型配置是可以逐行调试，生成一个资源，看看效果，再执行一行，再生成一个资源。
  - 类似于terraform复杂依赖关系的DAG图的配置，基于图的依赖模式，可以让资源子树独立重建，而命令式的配置，是线性的，只能按顺序线性重建。

	
### 孤立资源（Orphaned Instances）问题

我在2025年4月的腾讯云terraform 工程中，仍然遇到核心资源cvm的资源孤立问题，即terraform执行失败，但云上资源已建立，
云上资源的状态没有同步到本地状态文件。如果没有人工发现问题，这个资源将持续存在和付费。

它们就像是“被遗弃的孩子”，虽然还在云上“活着”，但已经失去了与“父母”（IaC 配置和状态文件）的联系。

但因为QPA工具没有local state存储，只依赖tag等技术标记云上资源，即：

单一事实来源: QPA不像Terraform一样在本地保留state文件，而是以云上资源状态为唯一状态事实来源，比如通过tag标记。

原理上，不会存在工具无法发现的孤立资源，因为QPA工具会提供所有标记过的资源的查询接口，而减少人工比对。
