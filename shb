#!/usr/bin/env bash
set -o errtrace  # -E trap inherited in sub script
set -o errexit   # -e
set -o functrace # -T If set, any trap on DEBUG and RETURN are inherited by shell functions
set -o pipefail  # default pipeline status==last command status, If set, status=any command fail

SHB_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
cd "$SHB_DIR"

# shellcheck disable=SC1091
source "./common.bash"

# ############################################################
# åŸºäºbashè„šæœ¬çš„monoé¡¹ç›®ç®¡ç†
# 1. åè¯:workspace/project/å­é¡¹ç›®,åè¯ç­‰åŒ
# 2. shbè„šæœ¬ä¸ºæ ¹è„šæœ¬ï¼Œä¸»è¦æ˜¯éå†å¤šä¸ªé¡¹ç›®æ‰§è¡Œå‘½ä»¤ï¼Œè€Œå„å­é¡¹ç›®çš„shaæ‰§è¡Œå®é™…æœ¬é¡¹ç›®å‘½ä»¤
# 3. é¡¹ç›®ç»„æ˜¯ç›¸åŒä½“ç³»è§„èŒƒçš„ä¸€ç»„é¡¹ç›®å®¹å™¨ï¼Œå¯å…±äº«å‘½ä»¤å®ç°ï¼Œ
#    æ¯”å¦‚å®šä¹‰ä¸€ä¸ªnpmç»„ï¼Œbuildå‘½ä»¤åªéœ€è¦å†™ä¸€æ¬¡å°±å¯ä»¥è¢«æ‰€æœ‰npmé¡¹ç›®ä½¿ç”¨ï¼Œé™¤éé¡¹ç›®æœ¬èº«å¯¹buildå‘½ä»¤æœ‰å…¶ç‰¹æ®Šå®ç°ï¼Œå¯è¦†ç›–ä¹‹
# 4. å¤šé¡¹ç›®å‘½ä»¤çš„å®ç°å’Œæ‰§è¡Œåˆ†3ä¸ªå±‚çº§ï¼šshb -> é¡¹ç›®ç»„-> é¡¹ç›®
#    æ¯”å¦‚æ‰§è¡Œ'shb build'ï¼Œå…ˆå¾ªç¯ä¸€ç»„é¡¹ç›®ï¼Œæ¯ä¸ªé¡¹ç›®åŠ è½½å…¶æ‰€å±é¡¹ç›®ç»„buildå‡½æ•°ï¼Œå†åŠ è½½é¡¹ç›®è‡ªå·±shaè„šæœ¬buildå‡½æ•°ï¼Œ
#    åˆ©ç”¨bashè„šæœ¬åå®šä¹‰çš„å‡½æ•°å¯è¦†ç›–å…ˆå®šä¹‰çš„å‡½æ•°çš„ç‰¹æ€§ï¼Œå¦‚æœé¡¹ç›®çš„shaè„šæœ¬æ²¡æœ‰buildå‡½æ•°å®ç°ï¼Œå°±æ‰§è¡Œé¡¹ç›®ç»„çš„buildå‡½æ•°ï¼Œ
#    å¦åˆ™ï¼Œæ‰§è¡Œé¡¹ç›®è‡ªå·±çš„buildå‡½æ•°ã€‚
# 5. é¡¹ç›®å®šä¹‰æ—¶æŒ‰ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„ï¼Œå…¶ä½œä¸ºé¡¹ç›®è¿‡æ»¤çš„ä¾æ®
#############################################################
declare -a __nodejs_workspaces=(
.
./packages/core
./packages/provider-tencentcloud
./packages/cli
)
declare -a __golang_workspaces=()

declare -a __all_workspaces=("${__golang_workspaces[@]}"  "${__nodejs_workspaces[@]}")

# å½“å‰å¾…å¤„ç†çš„é¡¹ç›®æ•°ç»„ï¼Œæš‚æ—¶å…¨éƒ¨ï¼Œå›å¤´é€šè¿‡è„šæœ¬option åŠ è¿‡æ»¤å™¨ åŠ¨æ€åŒ–æ­¤æ•°ç»„
declare -a __current_workspaces=("${__all_workspaces[@]}")

# å®šä¹‰ä¸€ä¸ªå…³è”æ•°ç»„æ¥å­˜å‚¨â€œç»„â€å¯¹åº”çš„é»˜è®¤ä»»åŠ¡åŠ è½½å‡½æ•°
# Key: ç»„å (e.g., "nodejs", "golang")
# Value: å¯¹åº”çš„åŠ è½½å‡½æ•°å (e.g., "_load_group_defaults_for_nodejs")
#declare -A __group_loaders
#declare -A __group_array_names

# Usage: _sha_register_group_loader <group_name> <loader_function_name>
# æ³¨å†Œä¸€ä¸ªç»„çš„é»˜è®¤ä»»åŠ¡åŠ è½½å‡½æ•°
#__register_group() {
#  local group_name="$1"
#  local loader_func="$2"
#  local group_array_name="$3"
#  __group_loaders["$group_name"]="$loader_func"
#  __group_array_names["$group_name"]="$group_array_name"
#}

#__register_group "all"    "_load_all_group_defaults"    "__all_workspaces"
#__register_group "nodejs" "_load_nodejs_group_defaults" "__nodejs_workspaces"
#__register_group "golang" "_load_golang_group_defaults" "__golang_workspaces"


# Usage: __execute_in_workspace <workspace> <cmd>
# æœ¬å‡½æ•°åšå¤šæ¬¡åŠ è½½ç›¸å…³é¡¹ç›®çš„å‘½ä»¤é›†ï¼Œå¤–éƒ¨æ‰§è¡Œæ—¶æœ€å¥½ç”¨å­è¿›ç¨‹å½¢å¼æ‰§è¡Œï¼š( __execute_in_workspace "workspace" "cmd" )
__execute_in_workspace(){
  local workspace="$1"
  local cmd="$2"
  if [[ "$workspace" == "" ]]; then echo "ERROR: ç¼ºå°‘<workspace>å‚æ•°,Usage: __execute_in_workspace <workspace> <cmd>"; fi
  if [[ "$cmd" == "" ]];     then echo "ERROR: ç¼ºå°‘<cmd>å‚æ•°,Usage: __execute_in_workspace <workspace> <cmd>"; fi

  shift 2
  local before_load
  before_load=$(declare -f $cmd)

  cd "$workspace"


#  local group_name
#  local group_array
#  for group_name in "${!__group_array_names[@]}"; do
#      declare -n group_array="${__group_array_names[$key]}"
#      for n in "${group_array[@]}"; do
#        if [[ "$workspace" == "$n" ]]; then
#          local loader_func="${__group_loaders[$group_name]}"
#          $loader_func
#          break;
#        fi
#      done
#  done

  _load_all_group_defaults

  for n in "${__nodejs_workspaces[@]}"; do
    if [[ "$workspace" == "$n" ]]; then
      _load_nodejs_group_defaults
      break;
    fi
  done

  ## load cmd function from workspace
  if [ -f "./sha" ]; then
    . "./sha"
  fi

  local after_load
  after_load=$(declare -f "$cmd")
  # å¦‚æœcmdçš„å‡½æ•°åŠ è½½å‰åå†…å®¹ç›¸åŒï¼Œè¯´æ˜ç”¨æˆ·å¹¶ä¸ºå®šä¹‰ç›¸å…³å‡½æ•°ï¼Œåˆ™å¿½ç•¥æ‰§è¡Œ
  if [[ "$before_load" == "$after_load" ]]; then
    echo "  âšªï¸ignore é¡¹ç›® $workspace æ‰§è¡Œ $cmd, å› ä¸ºæ‚¨æœªå®šä¹‰[$cmd]å‡½æ•°å®ç°"
    return 0
  fi
  # æ‰§è¡Œç›¸åº”çš„å‘½ä»¤å‡½æ•°
#  echo "run: $after_load"
  $cmd "$@"
}

__for_each_workspace() {
  local workspaces_array_name="$1" # æ•°ç»„åï¼Œä¾‹å¦‚ "__current_workspaces"
  local cmd="$2"
  shift # cmdä¿ç•™ï¼Œworkspaces_array_nameåœ¨æœ¬å‡½æ•°ä½¿ç”¨

  if [[ "$cmd" == "" ]];                       then echo "ERROR: ç¼ºå°‘<cmd>å‚æ•°,Usage: __for_each_workspace <workspaces_array_name> <cmd> "; fi
  if [[ "$workspaces_array_name" == "" ]];     then echo "ERROR: ç¼ºå°‘<workspaces_array_name>å‚æ•°,Usage: __for_each_workspace <workspaces_array_name> <cmd> "; fi

  local -n workspaces="$workspaces_array_name" # Bash 4.3+ nameref
  local workspace;
  for workspace in "${workspaces[@]}"; do
    # ç”¨()å»ºç«‹å­è¿›ç¨‹ï¼Œæ‰§è¡Œæ—¶äº’ä¸å¹²æ‰°
    (
        echo "ğŸŸª workspace: $workspace"
        __execute_in_workspace "$workspace" "$@"
    )
  done
}


##########################################
# app cmd script
# ä»¥ä¸‹ä¸ºåº”ç”¨çš„ä»»åŠ¡è„šæœ¬
##########################################

#############################################################
## workspacesçº§åˆ«çš„ä»»åŠ¡é›†(å¯å…¨å±€>ç»„>workspace è¦†ç›–å®ç°)
#############################################################

exec() {           __for_each_workspace __current_workspaces "exec"      "$@";}
clean() {          __for_each_workspace __current_workspaces "clean"     "$@";}
clean_all() {      __for_each_workspace __current_workspaces "clean_all" "$@";}
install() {        __for_each_workspace __current_workspaces "install"   "$@";}
build() {          __for_each_workspace __current_workspaces "build"     "$@";}
pack() {           __for_each_workspace __current_workspaces "pack"      "$@";}
test() {           __for_each_workspace __current_workspaces "test"      "$@";}
reinstall() {      __for_each_workspace __current_workspaces "reinstall" "$@";}
rebuild() {        __for_each_workspace __current_workspaces "rebuild"   "$@";}
retest() {         __for_each_workspace __current_workspaces "retest"    "$@";}
repack() {         __for_each_workspace __current_workspaces "repack"    "$@";}
info() {         __for_each_workspace __current_workspaces "info"    "$@";}

#############################################################
## ä»»åŠ¡çš„é»˜è®¤å®ç°
#############################################################

# å…¨å±€ï¼Œæ‰€æœ‰workspaceçš„é»˜è®¤ä»»åŠ¡/å‘½ä»¤é›†
# ä»»åŠ¡çš„è¦†ç›–é¡ºåºä¸ºï¼šå…¨å±€>ç»„>workspace
_load_all_group_defaults() {
  exec() { _run "$@"; }
  clean() {         _run rm -rf build dist out ;}
  clean_all() {     _run rm -rf build dist out node_modules pnpm-lock.yaml;}
}


#############################################################
## å…¶ä»–ä»»åŠ¡
#############################################################

npmjs() {
  login() {
    # æŒ‡å®š--registryé˜²æ­¢ç™»é™†è·³è½¬åˆ°é•œåƒç½‘ç«™
    npm login --registry=https://registry.npmjs.org/
  }
}


version() {
  info() { npm version --workspaces "$@"; }
  patch() { npm version patch --workspaces "$@"; }
  prerelease() { npm version prerelease --workspaces "$@";}
  push() {  git push origin --tags  "$@" ; }
}

pref() {
  hello() {
    # ç”Ÿæˆçš„ ./*.cpuprofile æ–‡ä»¶
    #    Chrome æµè§ˆå™¨ > æ‰“å¼€å¼€å‘è€…å·¥å…· > å¯¼èˆªåˆ° "Performance" (æ€§èƒ½) é¢æ¿ > ç‚¹å‡»é¢æ¿å·¦ä¸Šè§’åŠ è½½å›¾æ ‡ (ä¸€ä¸ªå‘ä¸Šçš„ç®­å¤´)
    #ã€‚      >  åŠ è½½ç”Ÿæˆçš„.cpuprofileæ–‡ä»¶
    node --cpu-prof "$(which pnpm)" run echo
  }
}


#############################################################
## è„šæœ¬å…¥å£
#############################################################

# å®ˆå«è¯­å¥ï¼Œå½“'source ./sha'æ‰§è¡Œï¼Œè„šæœ¬è¢«å½“ç±»åº“å¯¼å…¥æ—¶ï¼Œ$0ä¸ºbashæˆ–zshç­‰å€¼
# å³å½“ç±»åº“å¼•ç”¨æ—¶ä¸æ‰§è¡Œåç»­å‘½ä»¤å¼å…¥å£ä»£ç 
if [[ "${BASH_SOURCE[0]}" != "$0" ]]; then
  echo 'shbè„šæœ¬ä¸ºmonoé¡¹ç›®è„šæœ¬ï¼Œä¸èƒ½ä½œä¸ºç±»åº“å¯¼å…¥ï¼Œåªèƒ½å‘½ä»¤å¼æ‰§è¡Œ'
  exit 1
fi

# å½“è„šæœ¬è¢«ç›´æ¥æ‰§è¡Œçš„å…¥å£ä»£ç 
sha "$@"
